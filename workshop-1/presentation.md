---
author: Shivaraj
date: MMMM dd, YYYY
paging: Slide %d / %d
---

# Nix expression language (workshop-1)
## Let's learn Nix by examples!
### Write your first derivation
### Setup a development environment for the workshop material

---

## Quick Recap
### What is an attribute set?
```nix
{ foo = 1; bar = 2; }
```
### How do you define a function?
```nix
# Single parameter
foo: foo*2
# Multiple parameters
foo: bar: foo + bar
# Above is equivalent to
foo: (bar: foo + bar)
# Attrset as a parameter
{ foo, bar }: foo + bar
```
---
### Imports
examples/a.nix
```nix
{ x?1, y?2 }: x + y
```
examples/b.nix
```nix
{ i = import ./a.nix {}; j = import ./a.nix { x = 3; y = 4}; }
```
---
### Evaluate
```bash
nix eval -f workshop-1/examples/b.nix i
nix eval -f workshop-1/examples/b.nix j
```
---

## Builtin functions in Nix
### builtins attrset is a collection of all the builtin functions
### Example functions from builtins
```nix
map :: (a -> b) -> [a] -> [b]
```
For example:
```nix
map (x: "hello" + x) [ "world" "nix" ]
```
evaluates to
```nix
[ "helloworld" "hellonix" ]
```
---
### One more example
```nix
mapAttrs :: (a -> b -> c) -> AttrSet -> AttrSet
```
For example:
```nix
mapAttrs (name: value: name + value) { foo = "bar"; hello = "world"; }
```
evaluates to
```nix
{ foo = "foobar"; hello = "helloworld"; }
```
---
### And a couple more
```nix
concatLists :: [List] -> []
readFile :: Path -> String
```
### Search engine for all the builtin functions and more
https://noogle.dev/
---
### Write your first derivation
- It is a function in `builtins`. You can also access it without `builtins.derivation` because it is aliased to `derivation`.
- It takes an attribute set as an argument. The attribute set must have the following attributes:
  - `name`: The name of the derivation
  - `builder`: The path to the builder script
  - `system`: The system for which the derivation is built
```nix
nix-repl> derivation { name = "myderivation"; builder = "mybuilder"; system = "mysystem"; }
«derivation /nix/store/vc5j8bwssr3dq8zjlkyc78pd4fm89jk0-myderivation.drv»
```
---
### Visualise the derivation
```bash
nix show-derivation /nix/store/vc5j8bwssr3dq8zjlkyc78pd4fm89jk0-myderivation.drv 
```

---
### Build the derivation
```nix
nix-repl> :b derivation { name = "myderivation"; builder = "mybuilder"; system = "mysystem"; } 
 error: a 'mysystem' with features {} is required to build '/nix/store/vc5j8bwssr3dq8zjlkyc78pd4fm89jk0-myderivation.drv'
 , but I am a 'x86_64-darwin' with features {benchmark, big-parallel, nixos-test}
```
#### `mysystem` is not a valid system.
##### Call `builtins.currentSystem` to see what your system is
##### Internally it calls `uname -m` and `uname -s`. `uname` is a command line utility to print system information.
#### `mybuilder` is also not a valid builder. It should be a valid executable.
<!-- Appologise for the clickbaity title. -->
---
### Build a working derivation
#### Previous derivation will fail to build because of invalid builder. Let's fix that. 
#### We will be using `bash` as our builder from nixpkgs. Before that, let's understand what nixpkgs is.
#### You can think of it as the collection of these derivations. Someone else has written how to build those packages for us and we can use them.
Here's a basic script that bash can execute:
```bash
# examples/builder.sh
declare -xp
echo "Hello World!" > $out
```
`$out` is the path generated by nix for the output of the derivation. It has to be a file or folder. In this case, it is a file.

Let's build it:
```nix
nix-repl> :lf github:nixos/nixpkgs
nix-repl> bash = outputs.legacyPackages.aarch64-darwin.bash
nix-repl> bash
«derivation /nix/store/9xq9iv8mx8fzlhs9lq25654wz0smylvm-bash-5.2-p15.drv»
nix-repl> :b derivation { name = "myderivation"; builder = "${bash}/bin/bash"; args = [ ./workshop-1/examples/builder.sh ]; 
          system = builtins.currentSystem; }
 This derivation produced the following outputs:
  out -> /nix/store/58lzg17rjhzlkf8akghb2bqgpcmbc1vp-myderivation
```
---
### Let's analyze the previous derivation
#### Couple of observations you would've made:
- derivation hash has changed compared to the previous one
- Our derivation is built and the output stored in `$out`.

Here's what the file contains:
```bash
cat /nix/store/58lzg17rjhzlkf8akghb2bqgpcmbc1vp-myderivation
# Hello World!
``` 
#### What about the `declare -xp` part of the builder script?
As we have not specified where the output of that should go, it is printed during the build process. To see the build log, run:
```bash
nix log /nix/store/58lzg17rjhzlkf8akghb2bqgpcmbc1vp-myderivation
```
---
### Understanding the logs
Here's the output of the previous command:
```bash
declare -x HOME="/homeless-shelter"
declare -x NIX_BUILD_CORES="8"
declare -x NIX_BUILD_TOP="/private/tmp/nix-build-myderivation.>
declare -x NIX_LOG_FD="2"
declare -x NIX_STORE="/nix/store"
declare -x OLDPWD
declare -x PATH="/path-not-set"
declare -x PWD="/private/tmp/nix-build-myderivation.drv-0"
declare -x SHLVL="1"
declare -x TEMP="/private/tmp/nix-build-myderivation.drv-0"
declare -x TEMPDIR="/private/tmp/nix-build-myderivation.drv-0"
declare -x TERM="xterm-256color"
declare -x TMP="/private/tmp/nix-build-myderivation.drv-0"
declare -x TMPDIR="/private/tmp/nix-build-myderivation.drv-0"
declare -x builder="/nix/store/f2fi9x1fnwly702yqdlsjhy46pcgz5v>
declare -x name="myderivation"
declare -x out="/nix/store/58lzg17rjhzlkf8akghb2bqgpcmbc1vp-my>
declare -x system="aarch64-darwin"
```
#### The above output is partly the reason behind the isolated builds in nix.


